---
// src/pages/[...locale]/dj.astro
import "@/styles/global.css";
import { Image } from "astro:assets";
import BaseLayout from "@/layouts/BaseLayout.astro";
import PageLayout from "@/layouts/PageLayout.astro";
import { defaultLang, locales } from "@/../i18n.config";
import { getI18nInfo } from "@/utils/i18n";
import { djSocialNetworksList } from "@/constants/socialNetworksList";
import { djBio } from "@/constants/photos";
import { getLongSoundCloudTracksLinks } from "@/utils/getSoundCloudTracksLinks";
import SoundCloudPlayer from "@/components/SoundCloudPlayer.astro";
import Calendar from "@/components/Calendar.astro";
import { djGoogleCalendarSrc } from "@/constants/calendar";
import Separador from "@/components/Separador.astro";
import { getYoutubeSetsInfo } from "@/utils/getYoutubeVideosInfo";
import YouTubePlayer from "@/components/YouTubePlayer.astro";
import Carousel from "@/components/Carousel.astro";
import { djEmail } from "@/constants/email";

// Genera rutas estáticas: "/", "/en"
export function getStaticPaths() {
  return locales.map((lang) => {
    if (lang === defaultLang) {
      return { params: { locale: undefined } };
    }
    return { params: { locale: lang } };
  });
}

const { dictionary, langParam } = await getI18nInfo(Astro.params.locale);
const { djPage, common } = dictionary;

const setsLinks = await getLongSoundCloudTracksLinks();
const youTubeSetsInfo = await getYoutubeSetsInfo();
---

<BaseLayout
  title={djPage.title}
  lang={langParam}
  description={djPage.description}
>
  <PageLayout
    title={djPage.title}
    phrase={djPage.heading}
    socialNetworksList={djSocialNetworksList}
  >
    <div class="animate-on-scroll mb-4 flex w-full items-center gap-4">
      <div class="relative h-150 w-full md:h-150">
        <Image
          src={djBio}
          alt={djPage.bio.altImage}
          class="absolute h-full w-full rounded-lg object-cover object-top shadow-lg"
          loading="eager"
        />
      </div>
    </div>

    <section class="animate-on-scroll w-full">
      <div class="mb-4 flex w-full items-center gap-4">
        <Separador />
        <h3 class="shrink-0 text-2xl font-bold md:text-3xl">
          {djPage.sets.title}
        </h3>
        <Separador />
      </div>
      <div class="flex h-auto w-full flex-col justify-center gap-5">
        <Carousel>
          {
            youTubeSetsInfo?.map((setInfo) => (
              <YouTubePlayer title={setInfo.title} videoId={setInfo.videoId} />
            ))
          }
          {
            setsLinks?.map((link) => (
              <SoundCloudPlayer trackUrl={link} loading="lazy" />
            ))
          }
        </Carousel>
      </div>
    </section>

    <section class="animate-on-scroll w-full">
      <div class="mb-4 flex w-full items-center gap-4">
        <Separador />
        <h3 class="shrink-0 text-2xl font-bold md:text-3xl">
          {djPage.calendar.title}
        </h3>
        <Separador />
      </div>
      <Calendar
        googleCalendarSrc={djGoogleCalendarSrc}
        title={djPage.calendar.calendarTitle}
      />
    </section>

    <section class="animate-on-scroll w-full">
      <div class="mb-4 flex w-full items-center gap-4">
        <Separador />
        <h3 class="shrink-0 text-2xl font-bold md:text-3xl">
          {djPage.bio.title}
        </h3>
        <Separador />
      </div>
      <div class="flex w-full flex-col items-center gap-8">
        <p class="w-full text-justify text-base md:text-lg">
          {djPage.bio.text}
        </p>
      </div>
      <div class="mt-10 flex w-full items-center justify-center gap-8">
        <p class="text-center text-base md:text-lg">
          {common.contactMe}
        </p>
        <div
          id="copy-email"
          class="cursor-pointer font-bold transition-transform duration-300 ease-in-out hover:scale-110"
          title={common.copyToClipboard ?? "Copiar al portapapeles"}
        >
          {djEmail}
        </div>
      </div>
    </section>
  </PageLayout>
</BaseLayout>

<script>
  import { initScrollAnimations } from "@/utils/animations";
  // Ejecutamos la función en el evento 'astro:page-load'
  // Este evento se dispara en la carga inicial Y en cada navegación por View Transitions
  document.addEventListener("astro:page-load", () => {
    initScrollAnimations();

    const emailSpan = document.getElementById("copy-email");
    if (!emailSpan) return;

    const originalText = emailSpan.textContent;
    // Asumimos que el diccionario i18n tendrá una clave para el texto "Copiado"
    // Si no, usamos un valor por defecto.
    const copiedMessage =
      emailSpan.dataset.copiedText ??
      (document.documentElement.lang === "es" ? "¡Copiado!" : "Copied!");

    const handleClick = () => {
      if (!originalText) return;

      navigator.clipboard.writeText(originalText).then(() => {
        emailSpan.textContent = copiedMessage;
        setTimeout(() => {
          emailSpan.textContent = originalText;
        }, 1000);
      });
    };

    emailSpan.addEventListener("click", handleClick);
  });
</script>
